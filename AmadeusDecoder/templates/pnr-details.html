{% extends "layout-pnr-details.html" %}
{% load ticket_segments %}
{% load pnr_details %} 
{% load pnr_comments %}
{% load history %}
{% block content %}

<div id="findCreatorInformation"></div>
<div class="content-wrapper">
	<section class="content">
		<div class="container-fluid">
			<div class="row">
				<div class="col-md-12 mt-1">
					<form method='POST' action="">
						{% csrf_token %}
						<div class="row">
							{% with pnr|passenger_order_status as passenger_status %}
							<div class="col-md-4 passengers px-2 py-0 mb-2">
								<div style="position: sticky; top: 0; background-color: #f4f6f9;">
									<h4 class="text-primary pass py-0">Passagers</h4>
								</div>
								<div class="mb-2">
									{% for passenger in passengers %}
										<div class="pnr-details__passagers">
											{% with passenger.passenger.id|ticket_passenger_status as ticket_passenger_status %}
												{% with passenger.passenger.id|passenger_existence as passenger_existence %}	
													{% with passenger.passenger.id|passenger_is_invoiced as passenger_is_invoiced %}	
														{% with passenger.passenger.id|passenger_is_quotation as passenger_is_quotation %}	
														<p class="passagers {% if passenger_is_invoiced or passenger_is_quotation %} text-success {% elif ticket_passenger_status %} text-danger {% endif %} " >
															({{ passenger.passenger.order }}) {{ passenger.passenger.name }} 
															{% if passenger.passenger.surname is not None %}
															<span class="text-capitalize">{{ passenger.passenger.surname|title }}</span>
															{% endif %} 
															
															{% if passenger.passenger.designation is not None %}
															<span class="text-capitalize">{{ passenger.passenger.designation|title }}</span>
															{% endif %}
															<input type="hidden" name="passengers-ids" value="{{passenger.passenger.id}}"/>
														</p>
														{% endwith %}
													{% endwith %}
												{% endwith %}
											
												{% if passenger_status is not None %}
													{% with passenger.passenger.id|passenger_existence as passenger_existence %}
														{% if passenger_existence %}
															<input type="checkbox" class="to-hide-when-cancel passengers-align-checkboxes passengers-align-checkboxes-first p-checkbox check{{ passenger.passenger.id }}" id="passagers-check" data-id="{{ passenger.passenger.id }}" checked="" name="passagers-checkbox" hidden>
														{% else %}
															{% if not ticket_passenger_status %}
																<input type="checkbox" class="to-hide-when-cancel passengers-align-checkboxes passengers-align-checkboxes-first p-checkbox check{{ passenger.passenger.id }}" id="passagers-check" data-id="{{ passenger.passenger.id }}" checked="" name="passagers-checkbox">
															{% endif %}
														{% endif %}
													{% endwith %}
												{% elif passenger_status is None %}
													{% if not ticket_passenger_status %}
														<input type="checkbox" class="to-hide-when-cancel passengers-align-checkboxes passengers-align-checkboxes-first passagers-check p-checkbox check{{ passenger.passenger.id }}" id="passagers-check" data-id="{{ passenger.passenger.id }}" checked="" name="passagers-checkbox3333s">
													{% endif %}
												{% endif %}
											{% endwith %}
										</div>
									{% endfor %}
								</div>
							</div>
							<div class="col-md-8 px-2 py-0">
								<fieldset class="card card-primary card-outline mb-0">
									<div class="row mb-0 px-2 py-0">
										<div class="col-md-2">
											<h4 class="text-primary mx-0 mb-0">Détail du PNR</h4>
											{% if pnr.is_archived %}
												<div 
													class="btn btn-warning px-2 py-0" 
													onmouseover="this.style.backgroundColor='#ffc107'" 
													onmouseout="this.style.backgroundColor='#ffc107'" 
													style="border: none; cursor: help;"
													title="? Cliquer sur le bouton Signaler pour faire une demande si des billets sont manquants"
												>
													<i class="fa fa-warning"></i>
													<span>PNR archivé</span>
												</div>
											{% endif %}
										</div>
										<div class="col-md-4">
											{% if pnr.status_value == 0 %}
												{% with pnr|ticket_quotation_status as ticket_quotation_status %}
													{% with pnr|order_with_quotation as order_with_quotation %}
														{% if ticket_quotation_status and not order_with_quotation and not pnr.is_invoiced %}
															{% with pnr|get_order_customer as order_customer %}
																{% if order_customer is not None %}
																<p class="text-info mt-1 mb-0 cde_blink">
																	<i class="fas fa-circle-info"></i>
																	Un devis créé pour le client: "{{order_customer.client.intitule}}"
																</p>
																{% endif %}
															{% endwith %}
														{% endif %}
													{% endwith %}
												{% endwith %}
												{% with pnr|passenger_is_invoiced_in_passenger_invoice as passenger_is_invoiced_in_passenger_invoice %}
													{% if pnr.is_invoiced and passenger_is_invoiced_in_passenger_invoice %}
														<p class="text-success mt-1 mb-0 cde_blink">
															<i class="fa-solid fa-check-circle" aria-hidden="true"></i>
															Commande créée
														</p>
													{% endif %}
												{% endwith %}
											{% else %}
												{% with pnr|ticket_quotation_status as ticket_quotation_status %}
												{% if ticket_quotation_status %}
														<p class="text-success mt-1 mb-0 cde_blink">
															<i class="fas fa-check-circle " aria-hidden="true"></i> 
															Un devis a été créé.
														</p>
												{% endif %}
												{% endwith %}
											{% endif %}
										</div>
										<div class="col-md-2">
											{% if pnr.state == 1 %}
												<button 
													type="button" 
													class="btn btn-danger " 
													title="Envoi de mail pnr manquants"
												>
													<span><p class="mb-0 mx-2"><i class="fa fa-exclamation-triangle"></i>
														Envoi de mail pnr manquants</p></span>
												</button>
											
											{% endif %}
											{% if pnr.state == 2 %}
												<button 
													type="button" 
													class="btn btn-danger " 
													title="Envoi de mail pnr manquants">
													<span><p class="mb-0 mx-2"><i
														class="fa fa-exclamation-triangle "></i> Envoi de mail
													tarification billet manquants</p></span>
												</button>
											
											{% endif %}
										</div>
										<div id="pnr_id" data-id="{{pnr.id}}" hidden></div>
										<div class="col-md-2 pl-0 d-flex justify-content-center">
											<div class="pager-pnr mt-1 px-0 float-right d-flex align-items-center justify-content-center">
												{% with request|manage_pnr_switch_with_button as manage_pnr_switch_with_button %}
													<div id="managePnrToSwitch" data-pnr-to-switch="{{ manage_pnr_switch_with_button }}"></div>
												{% endwith %}

												<button type="button" id="previousPNR" class="prev-pnr mr-2 btn btn-sm btn-primary" title="Précedent">
													<i class="fa fa-chevron-left"></i>
												</button>

												<span id="pnrPosition" class="text-sm"></span>

												<button type="button" id="nextPNR" class="next-pnr ml-2 btn btn-sm btn-primary" title="Suivant">
													<i class="fa fa-chevron-right"></i>
												</button>
											</div>
										</div>
									</div>
									<div class="row mb-2 px-2 py-0">
										<div class="col-md-3 px-2">
											<p class="details-p mb-0">
												<span class="details-span text-primary">Agence</span> 
												{% if pnr|pnr_office %}
													{% if pnr|pnr_office|lower == 'web' %} 
														{{ pnr|pnr_office }} (Reçu dossier)
													{% else %}
														{{ pnr|pnr_office }}
													{% endif %}
												{% endif %}
											</p>
											
											
											<p class="details-p mb-0">
												<span class="details-span text-primary">Suivi par</span> 
												{% if pnr|pnr_emitter is not None and pnr.status_value == 0 %}
                          							{{ pnr|pnr_emitter }}
                        						{% endif %}
											</p>
											<p class="details-p mb-0"><span class="details-span text-primary">Réf. Cde</span> 
												<input type="text" hidden name="ref_cde" id="ref_cde" class="form-control form-control-sm sm-height" style="width: 50%; display: inline;" placeholder="Référence commande"/>
												{% with pnr|reference_from_passenger_invoice as reference_from_passenger_invoice %}
													<span id="spanRefCode">
														{% if reference_from_passenger_invoice == None %}
															{{ "" }}
														{% else %}
															{{ reference_from_passenger_invoice }}
														{% endif %}
													</span>
												{% endwith %}
											</p>

											{% if pnr.children_pnr or pnr.parent_pnr %}
												<p class="details-p mb-0">
													<span 
														class="details-span text-primary" 
														title="Vous trouverez les autres billets dans le(s) PNR associé(s)"
														style="cursor: pointer;"
													>PNR associés : </span> 
													{% for child in pnr.children_pnr %}
														<span class="children-pnr-span">{{ child }},</span>
													{% endfor %}
													{% for parent in pnr.parent_pnr %}
														<span class="parent-pnr-span">{{ parent }}</span>
														{% if not forloop.last %} {{ ", " }}{% endif %}
													{% endfor %}
												</p>
											{% endif %}


										</div>
										<div class="col-md-3 px-2">
											<p class="details-p mb-0"><span class="details-span text-primary">Date d'émission</span> 
												{% if pnr|ticket_issuing_date is not None and pnr.status_value == 0 %}
													{{ pnr|ticket_issuing_date|date:"d/m/y" }}
												{% endif %}
											</p>

											<div class="form-group mb-0">
												<span class="details-span text-primary">Client</span>
												{% with pnr|get_order_customer as order_customer %}
													{% if order_customer is not None and pnr.status_value == 1 %}
														<select class="form-control form-control-sm customer-select sm-height" style="display: none; font-size: 12px;" id="customer-list" name="customer-selection-input" data-placeholder="Sélectionner le client" >		
															<option value="" id=""></option>																						
															{% comment %} {% for client in clients %}
																<option value="{{ client.id }}">{{ client }} </option>
															{% endfor %} {% endcomment %}
														</select>
														{% for order in order_customer %}
															{% if order.ticket is not None or order.invoice_id is not None %}
															<div class="d-flex align-items-center pr-2" id="passagersCustomer" data-customer-id="{{ order.client.id }}">
																<span id="customerDefaultOrderPlace" class="mr-2 text-success contact">{{ order.ticket.passenger.order }} - </span>
																<span class="customer-default mr-2 contact" id="customerDefault" data-customer-default="{{ order.client.intitule }}" data-customer-id="{{ order.client.id }}">
																	{{ order.client }} ({{ order.client.id }})
																</span>
																<button
																	id="buttonShowCustomer"
																	title="Détail du client(e)"
																	class="d-flex align-items-center justify-content-center"
																	style="width: 22px; height: 22px; border: none;"
																	type="button"
																	data-toggle="modal" 
																	data-target="#show-customer" 
																	data-customer-id="{{ order.client.id }}"
																	data-customer-intitule="{{ order.client.intitule }}"
																	data-customer-email="{{ order.client.email }}"
																	data-customer-telephone="{{ order.client.telephone }}"
																	data-customer-address-1="{{ order.client.address_1 }}"
																	data-customer-address-2="{{ order.client.address_2 }}"
																	data-customer-code-postal="{{ order.client.code_postal }}"
																	data-customer-city="{{ order.client.city }}"
																	data-customer-departement="{{ order.client.departement }}"
																	data-customer-country="{{ order.client.country }}"
																>
																	<i class="fa fa-external-link" aria-hidden="true" style="font-size: 12px;"></i>
																</button>
																<button
																	id="buttonModifyCustomer"
																	title="Modifier le client(e)"
																	class="d-flex align-items-center justify-content-center ml-1"
																	style="width: 22px; height: 22px; border: none;"
																	type="button"
																	data-toggle="modal" 
																	data-target="#modifySelectedClient" 
																	data-customer-id="{{ order.client.id }}"
																	data-customer-intitule="{{ order.client.intitule }}"
																>
																	<i class="fa-solid fa-user-pen" data-customer-id="{{ order.client.id }}"></i>
																</button>
																<button
																	id="buttonRemoveCustomer"
																	title="Supprimer le client"
																	class="d-flex align-items-center justify-content-center ml-1 remove-customer-button"
																	style="width: 22px; height: 22px; border: none;"
																	type="button"
																	data-toggle="modal" 
																	data-target="#ModalRemoveCustomer"
																	data-customer-id="{{ order.client.id }}"
																	data-customer-intitule="{{ order.client.intitule }}"
																	data-customer-status="{{ order.status }}"
																>
																	<i class="fa-solid fa-trash" data-customer-id="{{ order.client.id }}"></i>
																</button>
															</div>
															{% endif %}
														{% endfor %}
													{% else %}
														<select class="form-control form-control-sm customer-select sm-height" style="display: none; font-size: 12px;" id="customer-list" name="customer-selection-input" data-placeholder="Sélectionner le client" >		
															<option value="" id=""></option>																						
															{% comment %} {% for client in clients %}
																<option value="{{ client.id }}">{{ client }} </option>
															{% endfor %} {% endcomment %}
														</select>
													{% endif %}
													{% for other_fee in other_fees %}
														{% with other_fee|other_fees_orders as other_fees_orders %}
															{% if other_fees_orders is not None and other_fees_orders.status == 'quotation' and pnr.status_value == 1 %}
															<div class="d-flex align-items-center pr-2" id="passagersCustomer" data-customer-id="{{ other_fees_orders.client.id }}">
																<span id="customerDefaultOrderPlace" class="mr-2 text-success contact">{{ other_fees_orders.fee_type }} - </span>
																<span class="customer-default mr-2 contact" id="customerDefault" data-customer-default="{{ other_fees_orders.client.intitule }}" data-customer-id="{{ other_fees_orders.client.id }}">
																	{{ other_fees_orders.client.intitule }} ({{ other_fees_orders.client.id }})
																</span>
																<button
																	id="buttonShowCustomer"
																	title="Détail du client(e)"
																	class="d-flex align-items-center justify-content-center"
																	style="width: 22px; height: 22px; border: none;"
																	type="button"
																	data-toggle="modal" 
																	data-target="#show-customer" 
																	data-customer-id="{{ other_fees_orders.client.id }}"
																	data-customer-intitule="{{ other_fees_orders.client.intitule }}"
																	data-customer-email="{{ other_fees_orders.client.email }}"
																	data-customer-telephone="{{ other_fees_orders.client.telephone }}"
																	data-customer-address-1="{{ other_fees_orders.client.address_1 }}"
																	data-customer-address-2="{{ other_fees_orders.client.address_2 }}"
																	data-customer-code-postal="{{ other_fees_orders.client.code_postal }}"
																	data-customer-city="{{ other_fees_orders.client.city }}"
																	data-customer-departement="{{ other_fees_orders.client.departement }}"
																	data-customer-country="{{ other_fees_orders.client.country }}"
																>
																	<i class="fa fa-external-link" aria-hidden="true" style="font-size: 12px;"></i>
																</button>

																{% with pnr|passenger_is_invoiced_in_passenger_invoice as passenger_is_invoiced_in_passenger_invoice %}
																	{% if not passenger_is_invoiced_in_passenger_invoice and not other_fees_orders.is_invoiced %}
																		<button
																			id="buttonModifyCustomer"
																			title="Modifier le client(e)"
																			class="d-flex align-items-center justify-content-center ml-1"
																			style="width: 22px; height: 22px; border: none;"
																			type="button"
																			data-toggle="modal" 
																			data-target="#modifySelectedClient" 
																			data-customer-id="{{ other_fees_orders.client.id }}"
																			data-customer-intitule="{{ other_fees_orders.client.intitule }}"
																		>
																			<i class="fa-solid fa-user-pen" data-customer-id="{{ other_fees_orders.client.id }}"></i>
																		</button>
																		<button
																			id="buttonRemoveCustomer"
																			title="Supprimer le client"
																			class="d-flex align-items-center justify-content-center ml-1 remove-customer-button"
																			style="width: 22px; height: 22px; border: none;"
																			type="button"
																			data-toggle="modal" 
																			data-target="#ModalRemoveCustomer" 
																			data-customer-id="{{ other_fees_orders.client.id }}"
																			data-customer-intitule="{{ other_fees_orders.client.intitule }}"
																			data-customer-status = "{{ other_fees_orders.status}}"
																		>
																			<i class="fa-solid fa-trash" data-customer-id="{{ other_fees_orders.client.id }}"></i>
																		</button>
																	{% endif %}
																{% endwith %}
															
															</div>
															{% endif %}
														{% endwith %}
													{% endfor %}
												{% endwith %}
												{% if passenger_status is not None and pnr.status_value == 0 %}
													{% for passengers_customer in passenger_status %}
														<div class="d-flex align-items-center pr-2" id="passagersCustomer" data-customer-id="{{ passengers_customer.client.id }}">
															<span id="customerDefaultOrderPlace" class="mr-2 text-success contact">{{ passengers_customer.ticket.passenger.order }} - </span>
															<span class="customer-default mr-2 contact" id="customerDefault" data-customer-default="{{ passengers_customer.client.intitule }}" data-customer-id="{{ passengers_customer.client.id }}">
																{{ passengers_customer.client.intitule }} ({{ passengers_customer.client.id }})
															</span>
															<button
																id="buttonShowCustomer"
																title="Détail du client(e)"
																class="d-flex align-items-center justify-content-center"
																style="width: 22px; height: 22px; border: none;"
																type="button"
																data-toggle="modal" 
																data-target="#show-customer" 
																data-customer-id="{{ passengers_customer.client.id }}"
																data-customer-intitule="{{ passengers_customer.client.intitule }}"
																data-customer-email="{{ passengers_customer.client.email }}"
																data-customer-telephone="{{ passengers_customer.client.telephone }}"
																data-customer-address-1="{{ passengers_customer.client.address_1 }}"
																data-customer-address-2="{{ passengers_customer.client.address_2 }}"
																data-customer-code-postal="{{ passengers_customer.client.code_postal }}"
																data-customer-city="{{ passengers_customer.client.city }}"
																data-customer-departement="{{ passengers_customer.client.departement }}"
																data-customer-country="{{ passengers_customer.client.country }}"
															>
																<i class="fa fa-external-link" aria-hidden="true" style="font-size: 12px;"></i>
															</button>
															
															{% if not passengers_customer.is_invoiced %}
																<button
																	id="buttonModifyCustomer"
																	title="Modifier le client(e)"
																	class="d-flex align-items-center justify-content-center ml-1"
																	style="width: 22px; height: 22px; border: none;"
																	type="button"
																	data-toggle="modal" 
																	data-target="#modifySelectedClient" 
																	data-customer-id="{{ passengers_customer.client.id }}"
																	data-customer-intitule="{{ passengers_customer.client.intitule }}"
																>
																	<i class="fa-solid fa-user-pen" data-customer-id="{{ passengers_customer.client.id }}"></i>
																</button>
																<button
																	id="buttonRemoveCustomer"
																	title="Supprimer le client"
																	class="d-flex align-items-center justify-content-center ml-1 remove-customer-button"
																	style="width: 22px; height: 22px; border: none;"
																	type="button"
																	data-toggle="modal" 
																	data-target="#ModalRemoveCustomer" 
																	data-customer-id="{{ passengers_customer.client.id }}"
																	data-customer-intitule="{{ passengers_customer.client.intitule }}"
																	data-customer-status = "{{ passengers_customer.status}}"
																>
																	<i class="fa-solid fa-trash" data-customer-id="{{ passengers_customer.client.id }}"></i>
																</button>
															{% endif %}
															
														</div>
													{% endfor %}
												{% endif %}
												{% for other_fee in other_fees %}
													{% with other_fee|other_fees_orders as other_fees_orders %}
														{% if other_fees_orders is not None and other_fees_orders.status == 'sale' and pnr.status_value == 0 %}
														<div class="d-flex align-items-center pr-2" id="passagersCustomer" data-customer-id="{{ other_fees_orders.client.id }}">
															<span id="customerDefaultOrderPlace" class="mr-2 text-success contact">{{ other_fees_orders.fee_type }} - </span>
															<span class="customer-default mr-2 contact" id="customerDefault" data-customer-default="{{ other_fees_orders.client.intitule }}" data-customer-id="{{ other_fees_orders.client.id }}">
																{{ other_fees_orders.client.intitule }} ({{ other_fees_orders.client.id }})
															</span>
															<button
																id="buttonShowCustomer"
																title="Détail du client(e)"
																class="d-flex align-items-center justify-content-center"
																style="width: 22px; height: 22px; border: none;"
																type="button"
																data-toggle="modal" 
																data-target="#show-customer" 
																data-customer-id="{{ other_fees_orders.client.id }}"
																data-customer-intitule="{{ other_fees_orders.client.intitule }}"
																data-customer-email="{{ other_fees_orders.client.email }}"
																data-customer-telephone="{{ other_fees_orders.client.telephone }}"
																data-customer-address-1="{{ other_fees_orders.client.address_1 }}"
																data-customer-address-2="{{ other_fees_orders.client.address_2 }}"
																data-customer-code-postal="{{ other_fees_orders.client.code_postal }}"
																data-customer-city="{{ other_fees_orders.client.city }}"
																data-customer-departement="{{ other_fees_orders.client.departement }}"
																data-customer-country="{{ other_fees_orders.client.country }}"
															>
																<i class="fa fa-external-link" aria-hidden="true" style="font-size: 12px;"></i>
															</button>

															{% with pnr|passenger_is_invoiced_in_passenger_invoice as passenger_is_invoiced_in_passenger_invoice %}
																{% if not passenger_is_invoiced_in_passenger_invoice and not other_fees_orders.is_invoiced %}
																	<button
																		id="buttonModifyCustomer"
																		title="Modifier le client(e)"
																		class="d-flex align-items-center justify-content-center ml-1"
																		style="width: 22px; height: 22px; border: none;"
																		type="button"
																		data-toggle="modal" 
																		data-target="#modifySelectedClient" 
																		data-customer-id="{{ other_fees_orders.client.id }}"
																		data-customer-intitule="{{ other_fees_orders.client.intitule }}"
																	>
																		<i class="fa-solid fa-user-pen" data-customer-id="{{ other_fees_orders.client.id }}"></i>
																	</button>
																	<button
																		id="buttonRemoveCustomer"
																		title="Supprimer le client"
																		class="d-flex align-items-center justify-content-center ml-1 remove-customer-button"
																		style="width: 22px; height: 22px; border: none;"
																		type="button"
																		data-toggle="modal" 
																		data-target="#ModalRemoveCustomer" 
																		data-customer-id="{{ other_fees_orders.client.id }}"
																		data-customer-intitule="{{ other_fees_orders.client.intitule }}"
																		data-customer-status = "{{ other_fees_orders.status}}"
																	>
																		<i class="fa-solid fa-trash" data-customer-id="{{ other_fees_orders.client.id }}"></i>
																	</button>
																{% endif %}
															{% endwith %}
														
														</div>
														{% endif %}
													{% endwith %}
												{% endfor %}
											</div>
											{% with pnr|passenger_informations as passenger_informations %}
												<a 
													id="buttonAddCustomer"
													class="a-link mb-0 add-customer" 
													role="button" 
													data-toggle="modal"
													data-target="#add-customer" 
													data-passenger-informations="{{ passenger_informations }}"
													hidden
												>
													<i class="fa fa-pen"></i>Créer un client
												</a>
											{% endwith %}
										</div>
										<div class="col-md-4 px-2">
											<p class="details-p mb-0" style="max-height: 65px; overflow-x: auto; overflow-y: auto;">
												<span class="details-span text-primary">Contact</span>
												{% for contact in contacts %}
													{% if contact.contacttype != "Email" %}
														<span class="contact">
															{{ contact.value }}
														</span>
													{% endif %}
												{% endfor %}
											</p>
											<p class="details-p mb-0" style="max-height: 65px; overflow-x: auto; overflow-y: auto;">
												<span class="details-span text-primary">Email</span>
												{% for contact in contacts %}
													{% if contact.contacttype == "Email" %}
														<span class="contact" id="detailsContactEmail">
															{{ contact.value }}
														</span>
														<span class="contact" id="removeDuplicatedContactEmail">
															{{ contact.value }}
														</span>
													{% endif %}
												{% endfor %}
											</p>
										</div>
										<div class="col-md-2 text-end all-btn">
											{% if request.user.role_id == 3 or 1 %}
											<a id="create-devis"
											   class="{% if pnr.status == 'Emis' %} disabled {% endif %} btn btn-sm-block btn-info create-devis mb-2 py-0 px-1"
											>
												<i class="fa fa-pen"></i>
												Créer devis
											</a>
											{% endif %}
											{% with pnr|passenger_is_invoiced_in_passenger_invoice as passenger_is_invoiced_in_passenger_invoice %} 
												<a 
													id="edit"
													class="btn btn-sm-block btn-primary edit mb-2 py-0 px-1" {% if pnr.is_invoiced and passenger_is_invoiced_in_passenger_invoice %} hidden="true" {% endif %}
												>
													<i class="fas fa-edit"></i>
													Modifier
												</a>
												{% if pnr.is_invoiced and passenger_is_invoiced_in_passenger_invoice %}
													<a 
														class="btn btn-sm-block btn-primary add-line mb-2 py-0 px-1"
														title="Ajouter une ligne" 
														role="button" 
														id="add-product-service-line"
													>
														<i class="fa fa-puzzle-piece"></i>
														<span class="text-sm">Ajouter un service</span>
													</a>
												{% endif %}
											{% endwith %}
											<button 
												type="button" 
												id="save" 
												class="btn btn-sm-block btn-success mb-2 py-0 px-1" 
												name="save-pnr-detail" 
												data-toggle="modal" 
												data-target=""
												hidden
											>
												<i class="fas fa-save" {% if pnr.is_invoiced %} disabled {% endif %}></i>
												Enregistrer
											</button>	

											<button 
												type="button" 
												id="create-command" 
												class="btn btn-sm-block btn-info mb-2 py-0 px-1" 
												data-toggle="modal"
												data-target="#modal-confirm-cmd" 
												{% if pnr.is_invoiced or pnr.status == "Non émis" or pnr.state == 1 %} 
													disabled 
												{% endif %}
											>
												<i class="fas fa-plus"></i>
												Créer commande
											</button>

											{% with pnr|check_invoiced_status as check_invoiced_status %}
												{% if check_invoiced_status %}
													<button 
														type="button" 
														id="unCheckAllCheckboxUninvoiced" 
														class="btn btn-sm-block btn-secondary mb-2 py-0 px-1"
														data-pnr-id="{{ pnr.id }}" 
													>
														<i class="fas fa-plus"></i>
														<span class="text-sm">Annuler la sélection</span>
													</button>
												{% endif %}
											{% endwith %}
											

											{% with pnr|check_if_one_or_many_passenger_is_invoiced as check_if_one_or_many_passenger_is_invoiced %}
												{% with pnr.id|customer_has_not_had_order as customer_has_not_had_order %}
													{% if check_if_one_or_many_passenger_is_invoiced %}
														<button
															type="button" 
															id="buttonCreateReceipt"
															class="btn btn-sm-block bg-warning bg-gradient py-0 px-1 mb-2"
															data-toggle="modal"
															data-target="#modalCreateReceipt" 
														>
															<i class="fa fa-print"></i>
															<span class="text-sm"> Imprimer </span>
														</button>	
													{% endif %}
												{% endwith %}
											{% endwith %}
											
											<a type="submit" id="cancel" class="btn btn-sm-block btn-danger py-0 px-1 mb-2" hidden><i
												class="fas fa-close"></i>
												Annuler</a>
										</div>
									</div>
								</fieldset>
							</div>
							{% endwith %}
						</div>
						<div class="row">
							<div class="col-md-12 px-2">
								<h6 class="text-primary float-left mb-0">Information de vols: (PNR Air segment)</h6>
								<div class="float-right">
									{% with pnr|fee_amount_total as fee_amount_total %}
									<strong class="text-info mr-4"><u>Total frais de services:</u> <span id="total-services-fees" data-amount-fees="{{ fee_amount_total|floatformat:'2' }}">{{ fee_amount_total|floatformat:'2' }}</span></strong>
									{% endwith %}
									{% with pnr|order_amount_total as order_amount_total %}
									<strong class="text-primary mr-4"><u>Montant total:</u> <span id="pnr-amount-total" data-amount-total="{{ order_amount_total|floatformat:'2' }}">{{ order_amount_total|floatformat:'2' }}</span></strong>
									{% endwith %}
									<a class="text-success" href="" data-toggle="modal"
										data-target="#modal-information">Autres informations</a>
								</div>
								<div class="table-responsive">
									<table
										class="table table-bordered table-head-fixed  pnr-details mb-1">
										<thead class="bg-info">
											<tr>
												<th width="10%">Segment</th>
												<th width="10%">Vols</th>
												<th width="10%">Classe</th>
												<th width="10%">Cabine</th>
												<th width="10%">Départ</th>
												<th width="10%">Arrivée</th>
												<th>Date et heure de départ</th>
												<th>Date et heure d'arrivée</th>
												{% if pnr.status != 'Emis' %}
												<th>OPC</th>
												{% endif %}
											</tr>
										</thead>
										<tbody>
											{% for segment in air_segments %}
											<tr>
												<td>{{ segment.segmentorder }}</td>
												<td>{{ segment }}</td>
												<td>{{ segment.flightclass }}</td>
												<td>{{ segment|flight_cabin }}</td>
												<td>{{ segment.codeorg.iata_code }}</td>
												<td>{{ segment.codedest.iata_code }}</td>
												<td>
													{% if segment.segment_state == 0 %}
														{{ segment.departuretime|date:"d/m/y H:i" }}
													{% else %}
														{{ segment.departuretime|date:"d/m/y" }}
													{% endif %}
												</td>
												<td>
													{% if segment.segment_state == 0 %}
														{{ segment.arrivaltime|date:"d/m/y H:i" }}
													{% else %}
														{{ 'Flown' }}
													{% endif %}
												</td>
												{% if pnr.status != 'Emis' %}
												<td>{{ segment|ticket_ssr_opc:None|date:"d/m/y H:i" }}</td>
												{% endif %}
											</tr>
											{% endfor %}
										</tbody>
									</table>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-12 px-2">
								<h6 class="text-primary mb-1">Billets et frais (en {{ 'Issoufali'|company_currency }})</h6>
								<div class="table-responsive" style="height: calc(80vh - 20rem); overflow-x:auto">
									<table class="table table-bordered table-head-fixed text-nowrap ticket" id="table-ticket-fees">
										<thead class="bg-info">
											<tr>
												<th>Type</th>
												<th width="15%">Article</th>
												<th>Passager(s)/Trajet</th>
												<th width="5%">Transport</th>
												<th width="5%">Taxe</th>
												<th width="5%">Total</th>
												<th width="8%">Passager/Segment(s)</th>
												<th>Date d'émission</th>
												<th>Date de commande</th>
												<th>Numéro de commande</th>
												<th>Emetteur </th>
												<th width="10%">Référence</th>
												<th width="2%"></th>
												<th width="2%"></th>
												<th width="2%"></th>
											</tr>
										</thead>
										<tbody id="table-ticket-fees-body">
											{% for ticket in tickets %}
											{% with ticket|ticket_not_ordered as ticket_not_ordered %}
											{% with ticket|ticket_cancel_void_status as ticket_cancel_void_status %}
											<tr class="{%if ticket_not_ordered.is_invoiced or ticket_not_ordered.is_quotation %} text-success {%endif%} {% if ticket_cancel_void_status %} text-primary {% endif %}">
												<td>
													<span class="type" style="font-size: 12px !important">
														{% if ticket.ticket_type == 'EMD' or ticket.ticket_type == 'TKT' %}
															{{ ticket.ticket_type }}
														{% elif ticket.ticket_type == 'CREDIT_NOTE' %}
															{{ 'Avoir' }}
														{% endif %}
													</span>
												</td>
												<td><span class="billet">{{ ticket }}</span></td>
												<td>
													{% if ticket.ticket_type == 'EMD' and pnr.type == 'EWA' %}
														{% if ticket.ticket_description is not None %}
															{{ ticket.ticket_description }}
														{% endif %}
													{% endif %}
													{% if ticket.passenger is not None %}
														{{ ticket.passenger }}
													{% else %}
														{{ ticket.id|tst_passenger }}
													{% endif %}
													<br>{{ ticket.id|route }}
												</td>
												<td><span class="montant">{{ ticket.transport_cost|floatformat:'2' }}</span>
												</td>
												<td><span class="montant">{{ ticket.tax|floatformat:'2' }}</span></td>
												<td><span class="montant ticket" value="{{ ticket.total|floatformat:'2' }}">{{ ticket.total|floatformat:'2' }}</span></td>
												<td>
													{% if ticket.passenger is None %}
													<div class="d-flex justify-content-center align-items-center">
														<span 
															class="tooltips empty-passenger" 
															tooltip="" 
															tooltip-position="bottom"
															tooltip-type="danger"
															data-ticket-number="{{ ticket.number }}"
														>
															<i class="fa fa-envelopes-bulk text-danger"></i>
														</span>
													</div>
														
													{% else %}
														{% if ticket.passenger.order is not None %}
															{{ ticket.passenger.order }}
														{% else %}
															{{ ticket.id|tst_passenger }}
														{% endif %}
												/{{ ticket.id|segment }}
													{% endif %}
												</td>
												<td>
													{% if ticket.issuing_date is not None %}
														{{ ticket.issuing_date|date:"d/m/y" }}
													{% else %}
														{{ '' }}
													{% endif %}
												</td>
												<td>
													{% if ticket.pnr_id is not None and ticket.pnr_id|ticket_datetime_invoice_created:ticket.id is not None %}
														{{ ticket.pnr_id|ticket_datetime_invoice_created:ticket.id|date:"d/m/y" }}
													{% else %}
														{{ '' }}
													{% endif %}
												</td>
												<td>
													{% if ticket.pnr_id is not None %}
														{% if ticket.pnr_id|ticket_invoice_number:ticket.id is not None %}
															{{ ticket.pnr_id|ticket_invoice_number:ticket.id }}
														{% else %}
															{{ '' }}
														{% endif %}
													{% endif %}
												</td>
												<td>{{ticket.emitter.username}}</td>
												<td>
													{% if ticket.is_refund and not ticket.is_deposit %}
														{{ "Remboursement" }}
													{% elif not ticket.is_refund and ticket.is_deposit %}
														{{ "Acompte" }}
													{% elif ticket.is_refund and ticket.is_deposit %}
														{{ "Remboursement"}}
													{% endif %}
												</td>
												{% if user.id == 58 or user.id == 42 %}
													<td>
														{% if not ticket.is_invoiced  %} 
															<button class="btn btn-warning px-2 py-1 deleteticket" title='Annuler le ticket' type="button" data-toggle="modal" 
																	data-target="#modalRemoveTicket" data-ticket-table="ticket" data-ticket-number="{{ticket.number}}" data-ticket-id="{{ticket.id}}">
																<i class="fa-solid fa-trash"></i>
															</button>
														{% endif %}
														
													</td>
												{% else %}
													<td>{{ '' }}</td>
												{% endif %}
												<td>{{ '' }}</td>
										
												<td class="checkbox">
													{% if ticket_not_ordered or ticket_cancel_void_status or ticket.is_invoiced%}
														<input type="checkbox" class="to-hide-when-cancel passagers-check checkto{{ticket.passenger.id}} ticket-checkbox-passenger checkbox-line-below" id="passagers-check" data-ticket-id = "{{ticket.id}}" data-id="{{ passenger.id }}" data-ticket-status = "1" data-commune-id = "{{ticket.id}}" data-amount-total="{{ ticket.total|floatformat:'2' }}" data-type="ticket" checked hidden>
													{% else %}
														<input type="checkbox" class="to-hide-when-cancel passagers-check user_id4555 checkto{{ticket.passenger.id}} ticket-checkbox-passenger checkbox-line-below" id="passagers-check" data-ticket-id = "{{ticket.id}}" data-id="{{ passenger.id }}" data-ticket-status = "0" data-commune-id = "{{ticket.id}}" data-amount-total="{{ ticket.total|floatformat:'2' }}" data-type="ticket" checked disabled>
													{% endif %}
												</td>
											</tr>
											{% endwith %}
											
											
											<!-- Ticket-related other fee -->
											{% with ticket|ticket_other_fee as temp_other_fee %}
												{% if temp_other_fee is not None %}
													{% with temp_other_fee|other_fees_orders as other_fees_orders %}
													<tr class="tr-other-fees {% if other_fees_orders.other_fee.is_invoiced %} text-success {% endif %} {% if temp_other_fee.fee_type != 'outsourcing' and not temp_other_fee.is_subjected_to_fee  %} text-primary {% endif %} " data-other-fee-id = "{{other_fee.id}}">
														<td><span class="type" style="font-size: 12px;">{{ temp_other_fee.fee_type }}</span></td>
														<td><span class="billet">{{ temp_other_fee.designation }}</span></td>
														{% if temp_other_fee|ancillary_passenger is not None %}
														<td>
															{{ temp_other_fee|ancillary_passenger }}
														</td>
														{% else %}
														<td> </td>
														{% endif %}
														<td><span class="montant">{{ temp_other_fee.cost|floatformat:'2' }}</span>
														</td>
														<td><span class="montant">{{ temp_other_fee.tax|floatformat:'2' }}</span></td>
														<td><span class="montant ticket" value="{{ temp_other_fee.total|floatformat:'2' }}">{{ temp_other_fee.total|floatformat:'2' }}</span></td>
														{% if temp_other_fee|ancillary_passenger_segment != '' %}
														<td>
															{{ temp_other_fee|ancillary_passenger_segment }}
														</td>
														{% else %}
														<td>
															{% if temp_other_fee.passenger_segment is not None %}
																{{ temp_other_fee.passenger_segment }}
															{% endif %}
														</td>
														{% endif %}
														<td>
															{% if temp_other_fee.creation_date is not None %}
																{{ temp_other_fee.creation_date|date:"d/m/y" }}
															{% else %}
																{{ 'Non émis' }}
															{% endif %}
														</td>
														<td>
															{% if temp_other_fee.pnr_id is not None and temp_other_fee.pnr_id|other_fee_datetime_invoice_created:temp_other_fee.id is not None %}
																{{ temp_other_fee.pnr_id|other_fee_datetime_invoice_created:temp_other_fee.id|date:"d/m/y" }}
															{% else %}
																{{ '' }}
															{% endif %}
														</td>
														<td>
															{% if temp_other_fee.pnr_id is not None %}
																{% if temp_other_fee.pnr_id|other_fee_invoice_number:temp_other_fee.id is not None %}
																	{{ temp_other_fee.pnr_id|other_fee_invoice_number:temp_other_fee.id }}
																{% else %}
																	{{ '' }}
																{% endif %}
															{% endif %}
														</td>
														<td>
															{% if temp_other_fee.emitter %}
																{{temp_other_fee.emitter.username}}
															{% elif temp_other_fee.issuing_agent_name %}
																{{temp_other_fee.issuing_agent_name}}
															{% else %}
																{{ '' }}
															{% endif %}
														<td></td>
														{% if user.role_id == 1 %}
															<td>
																{% if not ticket.is_invoiced  %} 
																	<button class="btn btn-warning px-2 py-1 deleteticket" title='Annuler le ticket' type="button" data-toggle="modal" 
																			data-target="#modalRemoveTicket" data-ticket-table="ticket" data-ticket-number="{{ticket.number}}" data-ticket-id="{{ticket.id}}">
																		<i class="fa-solid fa-trash"></i>
																	</button>
																{% endif %}
																
															</td>
														{% endif %}
														<td></td>
														{% if other_fees_orders or temp_other_fee.is_invoiced.is_invoiced %}
														<td class="checkbox"><input type="checkbox" class="to-hide-when-cancel other-fees-check p-checkbox other-fees-checkboxes check{{ temp_other_fee.id }} checkbox-line-below" id="passagers-check" data-other-fees-id = "{{temp_other_fee.id}}" data-id="{{ temp_other_fee.id }}" data-commune-id = "{{temp_other_fee.id}}" data-amount-total="{{ temp_other_fee.total|floatformat:'2' }}" data-type="other-fee" checked hidden></td>
														{% else %}
														<td class="checkbox"><input type="checkbox" class="to-hide-when-cancel other-fees-check p-checkbox other-fees-checkboxes check{{ temp_other_fee.id }} checkbox-line-below" id="passagers-check" data-other-fees-id = "{{temp_other_fee.id}}" data-id="{{ temp_other_fee.id }}" data-commune-id = "{{temp_other_fee.id}}" data-amount-total="{{ temp_other_fee.total|floatformat:'2' }}" data-type="other-fee" checked disabled></td>
														{% endif %}
														
													</tr>
													{% endwith %}
												{% endif %}
											{% endwith %}
											
											{% with ticket.id|fee as fee %}
											{% if fee is not None %}
											{% with fee|fee_not_ordered as fee_not_ordered %}
											{% with fee.id|is_fee_invoiced as is_fee_invoiced%}
											<tr class="tr-fee {% if fee.is_invoiced or fee_not_ordered.is_quotation %} text-success {% endif %} ">
												<td>Fee</td>
												<td>{{ fee.type }}</td>
												<td>{{ '' }}</td>
												<td>
													{% with pnr|find_fee_reduce_request:fee as find_fee_reduce_request %}
														<div class="d-flex align-items-center justify-content-around">
															{% if find_fee_reduce_request %}
																<div class="spinner-grow text-danger" role="status" style="width: 10px; height: 10px; cursor: pointer;" title="Diminution de frais de service en cours">
																	<span class="sr-only">Loading...</span>
																</div>
															{% endif %}
															<div class="d-flex align-items-center" style="justify-content: end;">
																<i id="iconFeeCost"
																class="fa-sharp fa-solid {% if fee.cost < fee.old_cost and fee.old_cost != 0 %} fa-caret-down text-danger {% elif fee.cost > fee.old_cost and fee.old_cost != 0 %} mt-1 fa-caret-up text-success {% endif %}"
																></i>
																<input id="fee-cost" 
																	data-fee-is-invoiced="{{ is_fee_invoiced }}"
																	class="inputeditable montant fee-cost {% if fee.cost < fee.old_cost and fee.old_cost != 0 %} text-danger {% elif fee.cost > fee.old_cost and fee.old_cost != 0 or fee.is_invoiced or fee_not_ordered.is_quotation %} text-success {% endif %}" 
																	data-user-id = "{{request.user.id}}"
																	data-role-id="{{request.user.role_id}}"
																	data-fee-id="{{fee.id}}" 
																	data-total-fee-cost="{{ fee.total|floatformat:'2' }}"
																	old-data-cost= "{{ fee.newest_cost|floatformat:'2' }}"
																	is-at-airport = "{% is_issued_at_airport ticket None %}"
																	data-cost="{{ fee.cost|floatformat:'2' }}" 
																	value="{{ fee.cost|floatformat:'2' }}" 
																	name="service-fees-cost-{{fee.id}}"
																	style='width:70px;'
																/>
															</div>
														</div>
													{% endwith %}
												</td>
												<td><span class="montant">{{ fee.tax|floatformat:'2' }}</span></td>
												<td><span class="montant fee-total" data-fee-total="{{ fee.total|floatformat:'2' }}">{{ fee.total|floatformat:'2' }}</span></td>
												<td>{{ '' }}</td>
												<td>
													{% if fee.ticket.issuing_date is not None %}
														{{ fee.ticket.issuing_date|date:"d/m/y" }}
													{% else %}
														{{ '' }}
													{% endif %}
												</td>
												<td>
													{% if fee.pnr_id is not None and fee.pnr_id|fee_datetime_invoice_created:fee.id is not None %}
														{{ fee.pnr_id|fee_datetime_invoice_created:fee.id|date:"d/m/y" }}
													{% else %}
														{{ '' }}
													{% endif %}
												</td>
												<td>
													{% if fee.pnr_id is not None %}
														{% if fee.pnr_id|fee_invoice_number:fee.id is not None %}
															{{ fee.pnr_id|fee_invoice_number:fee.id }}
														{% else %}
															{{ '' }}
														{% endif %}
													{% endif %}
												</td>
												<td>{{ticket.emitter.username}}</td>
												<td>{{ '' }}</td>
												<td>{{ '' }}</td>
												<td>{{ '' }}</td>
												<td class="checkbox">
													{% if fee_not_ordered or fee.is_invoiced %}
														<input type="checkbox" class="to-hide-when-cancel passagers-check checkto{{ticket.passenger.id}} checkbox-line-below ticket-fee-checkbox" id="passagers-check" data-amount-total="{{ fee.total|floatformat:'2' }}" data-id="{{ ticket.passenger.id }}" data-commune-id = "{{ticket.id}}" data-type="fee" checked hidden>
													{% else %}
														<input type="checkbox" class="to-hide-when-cancel passagers-check checkto{{ticket.passenger.id}} checkbox-line-below ticket-fee-checkbox" id="passagers-check" data-amount-total="{{ fee.total|floatformat:'2' }}" data-id="{{ ticket.passenger.id }}" data-commune-id = "{{ticket.id}}" data-type="fee" checked disabled>
													{% endif %}
												</td>
											</tr>
											{% endwith %}
											{% endwith %}
											{% endif %}
											{% endwith %}
											{% endwith %}
											{% endfor %}
											<!-- Other fees -->
											{% for other_fee in other_fees %}
											{% with other_fee|other_fees_orders as other_fees_orders %}
											{% with other_fee|other_fee_cancel_void_status as other_fee_cancel_void_status %}
											<tr class="tr-other-fees {% if other_fees_orders is not None and other_fees_orders.is_invoiced %} text-success {% endif %} {% if other_fee_cancel_void_status or other_fee.ticket is not None or other_fee.other_fee is not None %} text-primary {% endif %}" data-other-fee-id = "{{other_fee.id}}">
												<td><span class="type" style="font-size: 12px;">{{ other_fee.fee_type }}</span></td>
												<td><span class="billet">{{ other_fee.designation }}</span></td>
												{% if other_fee|ancillary_passenger is not None %}
												<td>
													{{ other_fee|ancillary_passenger }}
													{% if other_fee.fee_type == 'AVOIR COMPAGNIE' %}
														<br>{{ other_fee.id|route_avoir }}
													{% endif %}
												</td>
													
												{% else %}
												<td> </td>
												{% endif %}
												<td><span class="montant">{{ other_fee.cost|floatformat:'2' }}</span>
												</td>
												<td><span class="montant">{{ other_fee.tax|floatformat:'2' }}</span></td>
												<td><span class="montant ticket" value="{{ other_fee.total|floatformat:'2' }}">{{ other_fee.total|floatformat:'2' }}</span></td>
												{% if other_fee|ancillary_passenger_segment != '' %}
												<td>
													{{ other_fee|ancillary_passenger_segment }}
												</td>
													
												{% else %}
												<td>
													{% if other_fee.passenger_segment is not None %}
														{{ other_fee.passenger_segment }}
													{% endif %}
												</td>
												
												
													
												{% endif %}
												<td>
													{% if other_fee.creation_date is not None %}
														{{ other_fee.creation_date|date:"d/m/y" }}
													{% else %}
														{{ '' }}
													{% endif %}
												</td>
												<td>
													{% if other_fee.pnr_id is not None and other_fee.pnr_id|other_fee_datetime_invoice_created:other_fee.id is not None %}
														{{ other_fee.pnr_id|other_fee_datetime_invoice_created:other_fee.id|date:"d/m/y" }}
													{% else %}
														{{ '' }}
													{% endif %}
												</td>
												<td>
													{% if other_fee.pnr_id is not None %}
														{% if other_fee.pnr_id|other_fee_invoice_number:other_fee.id is not None %}
															{{ other_fee.pnr_id|other_fee_invoice_number:other_fee.id }}
														{% else %}
															{{ '' }}
														{% endif %}
													{% endif %}
												</td>
												<td>
													{% if other_fee.emitter %}
														{{other_fee.emitter.username}}
													{% elif other_fee.issuing_agent_name %}
														{{other_fee.issuing_agent_name}}
													{% else %}
														{{ '' }}
													{% endif %}
												</td>
												<td></td>
												{% if user.id == 58 or user.id == 42 %}
													<td>
														{% if not other_fee.is_invoiced  %}
															<button class="btn btn-warning px-2 py-1 deleteticket" title='Annuler le ticket' type="button" data-toggle="modal" 
																	data-target="#modalRemoveTicket" data-ticket-table="other_fee" data-ticket-number="{{other_fee.number}}" data-ticket-designation="{{other_fee.designation}}" data-ticket-id="{{other_fee.id}}">
																<i class="fa-solid fa-trash"></i>
															</button>
														{% endif %}
														
													</td>
												{% else %}
													<td> {{ '' }} </td>	 
												{% endif %}

												<td>
													<!---- only if other_fee is not already invoiced that yan can remove it ----->
													
													{% if not other_fee.is_invoiced %}
													{% comment %} {{other_fee.is_invoiced}} {% endcomment %}
														<button id="deleteOtherFeeService"
																class="btn btn-danger d-none px-2 py-1" 
																type="button" 
																data-toggle="modal"
																data-target="#modalRemoveOtherFeeService"
																
																{% if other_fee.fee_type == 'AVOIR COMPAGNIE' %}
																	title = "Supprimer l' {{ other_fee.fee_type }} à {{ other_fee.cost|floatformat:'2' }} euros"
																{% else %}
																	title="Supprimer {{ other_fee.designation }} à {{ other_fee.cost|floatformat:'2' }} euros"
																{% endif %}
																	
																
																data-other-fee-id="{{ other_fee.id }}"
																data-other-fee-designation="{{ other_fee.designation }}" data-other-fee-type="{{ other_fee.fee_type }}"
																data-other-fee-total="{{ other_fee.total }}"
														>
															<i class="fa-solid fa-trash"></i>
														</button>
													
													{% endif %}
													<!---------------------- remove other_fee buttons --------------------------->
												</td>
												{% if other_fees_orders is not None or other_fee_cancel_void_status or other_fee.ticket is not None or other_fee.other_fee is not None or other_fee.is_invoiced%}
												<td class="checkbox"><input type="checkbox" class="to-hide-when-cancel other-fees-check p-checkbox other-fees-checkboxes check{{ other_fee.id }} checkbox-line-below" id="passagers-check" data-other-fees-id = "{{other_fee.id}}" data-id="{{ other_fee.id }}" data-commune-id = "{{other_fee.id}}" data-amount-total="{{ other_fee.total|floatformat:'2' }}" data-type="other-fee" checked hidden></td>
												{% else %}
												<td class="checkbox"><input type="checkbox" class="to-hide-when-cancel other-fees-check p-checkbox other-fees-checkboxes check{{ other_fee.id }} checkbox-line-below" id="passagers-check" data-other-fees-id = "{{other_fee.id}}" data-id="{{ other_fee.id }}" data-commune-id = "{{other_fee.id}}" data-amount-total="{{ other_fee.total|floatformat:'2' }}" data-type="other-fee" checked disabled></td>
												{% endif %}
												
											</tr>
											<!-- other fee fee -->
											{% with other_fee.id|other_fee_fee as fee %}
											{% if fee is not None %}
											{% with fee|other_fees_fees_orders as other_fees_fees_orders %}
											{% with other_fee.id|is_other_fee_invoiced as is_other_fee_invoiced %}
											<tr class="tr-other-fees-fee {% if fee.is_invoiced %} text-success {% endif %}" data-other-fee-id="{{ other_fee.id}}" data-fee-id="{{ fee.id }}">
												<td>Fee</td>
												<td>{{ fee.type }}</td>
												<td>{{ '' }}</td>
												<td>
													{% with pnr|find_fee_reduce_request:fee as find_fee_reduce_request %}
														<div class="d-flex align-items-center justify-content-around">
															{% if find_fee_reduce_request %}
																<div class="spinner-grow text-danger" role="status" style="width: 10px; height: 10px; cursor: pointer;" title="Diminution de frais de service en cours">
																	<span class="sr-only">Loading...</span>
																</div>
															{% endif %}
															<div class="d-flex align-items-center" style="justify-content: end;">
																<i id="iconFeeCost"
																class="fa-sharp fa-solid {% if fee.cost < fee.old_cost and fee.old_cost != 0 %} fa-caret-down text-danger {% elif fee.cost > fee.old_cost and fee.old_cost != 0 %} mt-1 fa-caret-up text-success {% endif %}"
																></i>
																<input id="fee-cost" 
																	data-other-fee-is-invoiced="{{ is_other_fee_invoiced }}"
																	class="inputeditable montant fee-cost {% if fee.cost < fee.old_cost and fee.old_cost != 0 %} text-danger {% elif fee.cost > fee.old_cost and fee.old_cost != 0 or fee.is_invoiced %} text-success {% endif %}" 
																	data-user-id = "{{request.user.id}}"
																	data-role-id="{{request.user.role_id}}"
																	data-fee-id="{{fee.id}}" 
																	data-total-fee-cost="{{ fee.total|floatformat:'2' }}"
																	old-data-cost= "{{ fee.newest_cost|floatformat:'2' }}" 
																	is-at-airport = "{% is_issued_at_airport None other_fee %}"
																	data-cost="{{ fee.cost|floatformat:'2' }}" 
																	value="{{ fee.cost|floatformat:'2' }}" 
																	name="service-fees-cost-{{fee.id}}"
																	style='width:70px;'
																/>
															</div>
														</div>
													{% endwith %}
												</td>
												<td><span class="montant">{{ fee.tax|floatformat:'2' }}</span></td>
												<td><span class="montant fee-total" data-fee-total="{{ fee.total|floatformat:'2' }}">{{ fee.total|floatformat:'2' }}</span></td>
												<td>{{ '' }}</td>
												<td>
													{% if other_fee.creation_date is not None %}
														{{ other_fee.creation_date|date:"d/m/y" }}
													{% else %}
														{{ '' }}
													{% endif %}
												</td>
												<td>
													{% if other_fee.pnr_id is not None and other_fee.pnr_id|other_fee_datetime_invoice_created:other_fee.id is not None %}
														{{ other_fee.pnr_id|other_fee_datetime_invoice_created:other_fee.id|date:"d/m/y" }}
													{% else %}
														{{ '' }}
													{% endif %}
												</td>
												<td>
													{% if other_fee.pnr_id is not None %}
														{% if other_fee.pnr_id|other_fee_invoice_number:other_fee.id is not None %}
															{{ other_fee.pnr_id|other_fee_invoice_number:other_fee.id }}
														{% else %}
															{{ '' }}
														{% endif %}
													{% endif %}
												</td>
												<td>
													{% if other_fee.emitter %}
														{{other_fee.emitter.username}}
													{% elif other_fee.issuing_agent_name %}
														{{other_fee.issuing_agent_name}}
													{% else %}
														{{ '' }}
													{% endif %}
												</td>
												<td>{{ '' }}</td>
												{% if user.role_id == 1 %}<td></td>{% endif %}

												<td>{{ '' }}</td>
												{% if other_fees_fees_orders is not None or fee.is_invoiced %}
												<td class="checkbox"><input type="checkbox" class="to-hide-when-cancel p-checkbox checkto{{other_fee.id}} other-fee-fee-checkbox" id="passagers-check checkbox-line-below" data-amount-total= "{{ fee.total|floatformat:'2' }}" data-commune-id = "{{other_fee.id}}" data-type="fee" checked hidden></td>
												{% else %}
												<td class="checkbox"><input type="checkbox" class="to-hide-when-cancel p-checkbox checkto{{other_fee.id}} other-fee-fee-checkbox" id="passagers-check checkbox-line-below" data-amount-total= "{{ fee.total|floatformat:'2' }}" data-commune-id = "{{other_fee.id}}" data-type="fee" checked disabled></td>
												{% endif %}
											</tr>
											{% endwith %}
											{% endwith %}
											{% endif %}
											{% endwith %}
											{% endwith %}
											{% endwith %}
											{% endfor %}
											
											<tr class="new-line" hidden>
												<td id="product-type-initial">Autres</td>
												<td>
													<div class="form-group mb-0">
														<select class="form-control form-control-sm" id="SelectProduct" name="service-type-dropdown">
															<option hidden>Type</option>
															{% for product in products %}
															<option value="{{product.id}}" data-designation="{{product.designation}}">{{product.designation}}</option>
															{% endfor %}
														</select>
														<input type='text' class="form-control form-control-sm" id='ticket-avoir' maxlength='16' placeholder='1452145213651-47' name='ticket-avoir' />
													</div>
												</td>
												<td>
													<select id="select_Passenger" class="form-control form-control-sm" ></select>
												</td>
												<td><input type="number" step="0.01" name="transport-input-line" class="form-control form-control-sm" id="transport-input-line"
													placeholder="Transport" name="transport-input-line" style="text-align:right;" value=""></td>
												<td><input type="number" step="0.01" name="taxe-input-line" class="form-control form-control-sm" id="taxe-input-line"
													placeholder="Taxe" name="taxe-input-line" style="text-align:right;" value=""></td>
												<td name="total-input-line" style="padding-top:15px; text-align:right;"></td>
												<td>
													<input type="text" class="form-control form-control-sm"
														placeholder="Passager/Segment" id="passenger_segment" name="passenger-input-line">
 
														<select id="multipleSelect" multiple name="native-select" placeholder="Segment" data-search="false" data-silent-initial-value-set="true">
														</select>
												</td>
												<td></td>
												<td></td>
												<td></td>
												<td></td>
												<td></td>
												<td>
													<button 
														type="button" 
														class="btn btn-success save-line py-0" 
														name="save-service-line"
														id="save-product-select"
														hidden
													>
														<i class="fas fa-save"></i>
													</button>
												</td>
												<td>
													<a 
														role="button" 
														class="btn btn-danger ignore py-0"
														id = "cancel-product-line"
														hidden
													>
														<i class="fas fa-close"></i>
													</a>
												</td>
											</tr>

										</tbody>
									</table>
									<div class="tr-add-line p-0" hidden>
										<a class="btn btn-outline-primary add-line py-0 px-2"
												title="Ajouter une ligne" role="button" id="add-product-service-line"><i class="fa fa-pen"
													aria-hidden="true"></i>Ajouter une ligne</a>
									</div>
								</div>
							</div>
						</div>
						<!--modal confirm command-->
						<div class="modal fade" id="modal-confirm-cmd" style="display: none;" aria-hidden="true">
							<div class="modal-dialog">
								<div class="modal-content" id="createOrderForCustomer">
									<div class="modal-header">
										<div>
											<h4 class="modal-title">Voulez-vous créer une commande pour	:</h4>
									
											{% with pnr|passenger_order_status as passenger_status %}
												{% if passenger_status %}
													{% for passengers_customer in passenger_status %}
														{% with pnr|passenger_order_status_invoiced:passengers_customer.client.id as passenger_order_status_invoiced %}		
															<div class="d-flex align-items-center pr-2" id="ConfirmationPassagersCustomer">
																{% if not passenger_order_status_invoiced and passengers_customer.status == 'sale' %}
																	{% with pnr.id|check_passenger_missing:passengers_customer.client.id as check_passenger_missing %}
																		<span id="checkPassengerMissing" data-count-passenger-missing="{{ check_passenger_missing }}"></span>
																		{% if check_passenger_missing > 0 %}
																			<input 
																				type="checkbox" 
																				id="ConfirmationCustomerOrderCheckbox" 
																				data-customer-id={{ passengers_customer.client.id }} 
																				class="mr-2 confirmation-customer-checkbox passenger-missing" 
																				data-customer-is-invoiced="{{ passenger_order_status_invoiced }}" 
																				checked
																				data-count-passenger-missing="{{ check_passenger_missing }}"
																				disabled
																			>
																		{% else %}
																			<input 
																				type="checkbox" 
																				id="ConfirmationCustomerOrderCheckbox" 
																				data-customer-id={{ passengers_customer.client.id }} 
																				class="mr-2 confirmation-customer-checkbox" 
																				data-customer-is-invoiced="{{ passenger_order_status_invoiced }}" 
																				data-count-passenger-missing="{{ check_passenger_missing }}"
																				checked
																			>
																		{% endif %}
																		<span 
																			id="ConfirmationCustomerDefaultOrderPlace" 
																			class="mr-2 text-success contact"
																			>
																			{{ passengers_customer.ticket.passenger.order }} - 
																		</span>
																		<span 
																			class="confirmation-customer-default mr-2 contact {% if check_passenger_missing > 0 %} text-danger {% endif %}" 
																			id="ConfirmationCustomerDefault" 
																			data-customer-default="{{ passengers_customer.client.intitule }}" 
																			data-customer-id="{{ passengers_customer.client.id }}"
																			
																			>
																			{{ passengers_customer.client.intitule }} ({{ passengers_customer.client.id }})
																		</span>
																	{% endwith %}
																{% elif passenger_order_status_invoiced and passengers_customer.status == 'sale' %}	
																	<input 
																		type="checkbox" 
																		id="ConfirmationCustomerOrderCheckbox" 
																		data-customer-id={{ passengers_customer.client.id }} 
																		class="mr-2 confirmation-customer-checkbox" 
																		data-customer-is-invoiced="{{ passenger_order_status_invoiced }}"  
																		checked 
																		disabled
																	>
																	<span 
																		id="ConfirmationCustomerDefaultOrderPlace" 
																		class="mr-2 text-success contact"
																	>
																		{{ passengers_customer.ticket.passenger.order }} - 
																	</span>
																	<span 
																		class="confirmation-customer-default mr-2 contact text-success" 
																		id="ConfirmationCustomerDefault" 
																		data-customer-default="{{ passengers_customer.client.intitule }}" 
																		data-customer-id="{{ passengers_customer.client.id }}"
																	>
																		{{ passengers_customer.client.intitule }} ({{ passengers_customer.client.id }})
																	</span>
																{% endif %}
																
															</div>
														{% endwith %}
													{% endfor %}
												{% endif %}
											{% endwith %}
											{% for other_fee in other_fees %}
												{% with other_fee|other_fees_orders as other_fees_orders %}
												<!-- fix EMD can't be ordered 00DO9X : erreur commande ne peux pas se créer -->
												{% with pnr|other_fees_orders_is_invoiced as other_fees_orders_is_invoiced %}
												{% if other_fees_orders is not None %}
												<div class="d-flex align-items-center pr-2" id="ConfirmationPassagersCustomer">
													{% if not other_fees_orders_is_invoiced and other_fees_orders.status == 'sale' %}
														<input 
															type="checkbox" 
															id="ConfirmationCustomerOrderCheckbox" 
															data-customer-id={{ other_fees_orders.client.id }} 
															class="mr-2 confirmation-customer-checkbox" 
															checked
														>
														<span 
															id="ConfirmationCustomerDefaultOrderPlace" 
															class="mr-2 text-success contact"
														>
															{{ other_fees_orders.other_fee.fee_type }} - 
														</span>
														<span 
															class="confirmation-customer-default mr-2 contact" 
															id="ConfirmationCustomerDefault" 
															data-customer-default="{{ other_fees_orders.client.intitule }}" 
															data-customer-id="{{ other_fees_orders.client.id }}"
														>
															{{ other_fees_orders.client.intitule }} ({{ other_fees_orders.client.id }})
														</span>
													{% elif other_fees_orders_is_invoiced and other_fees_orders.status == 'sale' %}
														<input 
															type="checkbox" 
															id="ConfirmationCustomerOrderCheckbox" 
															data-customer-id={{ other_fees_orders.client.id }} 
															class="mr-2 confirmation-customer-checkbox" 
															checked 
															disabled
														>
														<span 
															id="ConfirmationCustomerDefaultOrderPlace" 
															class="mr-2 text-success contact"
														>
															{{ other_fees_orders.other_fee.fee_type }} - 
														</span>
														<span 
															class="confirmation-customer-default mr-2 contact text-success" 
															id="ConfirmationCustomerDefault" 
															data-customer-default="{{ other_fees_orders.client.intitule }}" 
															data-customer-id="{{ other_fees_orders.client.id }}"
														>
															{{ other_fees_orders.client.intitule }} ({{ other_fees_orders.client.id }})
														</span>
													{% endif %}
												</div>
												{% endif %}
												{% endwith %}
												{% endwith %}
											{% endfor %}

											<div class="text-danger text-sm" id="error__noPassengerForTicket" style="display: grid;"></div>
											
											{% with pnr.id|total_amount_order as total_amount_order %}
											<div class="float-right text-body-secondary" id="totalAmountPerCheckboxChecked" data-each-amount-order="{{ total_amount_order }}" data-total-amount-order="{{ pnr.invoice.detail.total|floatformat:'2' }}">
												<u>Montant total:</u>
												<span id="spanTotalAmountPerCheckboxChecked"> {{ 0 }} </span>
											</div>
											{% endwith %}
											

										</div>
										
										<button class="close" data-dismiss="modal" aria-label="Close">
											<span aria-hidden="true">×</span>
										</button>
									</div>
									
									<div class="modal-footer">
										<button type="button" class="btn btn-success" data-dismiss="modal" id="create-final-command">Confirmer</button>
										<a class="btn btn-danger" data-dismiss="modal">Annuler</a>
									</div>
								</div>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
	</section>
</div>
<!--modal constat-->
<div class="modal fade" id="modal-constat" style="display: none;" aria-hidden="true">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title">Constat</h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">×</span>
				</button>
			</div>
				<div class="modal-body">
					
					{% if user.role_id == 1 or pnr.is_archived%}
					<div style="margin-bottom:5px;">
						<button class="btn btn-info" id="comment-ticket" enabled>Billet non remonté</button>
					</div>
					{% endif %}
						
					<div>
						<div id="comment-ticket-form">
							{% csrf_token %}
							<div id='list-ticket' ></div>

							<div id='ticket_input' hidden>
								<label for="ticket_number" class="col-form-label">Numero du Billet:</label>
								<input type='text' maxlength='16' name="ticket_number" class="form-control" id="ticket_number">
								<input type='hidden' name="pnr_id" value="{{pnr.id}}" class="form-control" id="pnr-id" >
								
							</div>

							

							<div id='info'>
								<label for="montant_hors_taxe" class="col-form-label">Montant Hors Taxe</label>
								<input type='number' name="montant_hors_taxe" class="form-control" id="montant_hors_taxe">
								<label for="taxe" class="col-form-label">Taxe</label>
								<input type='number' name="taxe" class="form-control" id="taxe">
								<input type='hidden' name="user_id" value="{{user.id}}" class="form-control" id="user_id" >
								
							</div>

							<div id='other_info'>
								<div>
									<label for="taxe" class="col-form-label">Type du Billet</label>
									<select id="selectType" class="form-control form-control select-type">
										<option value='TKT'>TKT</option>
										<option value='EMD'>EMD</option>
									</select>
								</div>
								<div class="form-check" id="fee">
									<input class="form-check-input" type="checkbox" value=""  id="feecheckbox">
									<label class="form-check-label" for="flexCheckDefault">
										frais de service
									</label>
								</div>
								
								<div>
									<label for="selectPassenger" class="col-form-label">Passenger</label>
									<select id="selectPassenger" class="form-control form-control">
									</select>
								</div>
								<div>
									<label for="selectSegment" id="SegmentLabel" class="col-form-label">Segment</label>
									<br>
									<select id="selectSegment" multiple name="native-select" placeholder="Segment" data-search="false" data-silent-initial-value-set="true" >	
									</select>
								</div>
								
							</div>
							<div>
								<button class="btn btn-success" id="comment-ticket-next-button" style="margin-top:5px;" disabled>Confirmer</button>
								<button class="btn btn-danger" id="comment-ticket-cancel-button" style="margin-top:5px;" >Annuler</button>            
							</div>

							
							    
						</div>

						<form action="" method="post" id="comment-form">
							{% csrf_token %}
							<div class="form-group">
								<textarea class="form-control comment-detected-anomaly" rows="3"
									placeholder="Anomalie détectée..." id="comment"></textarea>
							</div>
						<button class="btn btn-success" id="send-comment" disabled>Envoyer</button>
					</form>
					</div>
					
					{% with pnr|anomaly_comments as anomaly_comments %}
						{% if anomaly_comments is not None %}
							<div style="padding:5px; margin-top:10px; border-radius:3px;">
								<p style="margin-top:5px;font-weight:800;">Anomalies sur ce PNR:</p>
								{% for anomaly in anomaly_comments %}
									{% if anomaly.sender %}
										{% with anomaly.comment|strip as comment %}
											{% if comment != "" %}
												<div class="d-flex justify-content-start align-items-center" style="gap: 1rem; margin-bottom: 0.4rem;">
													<div class="container-comment" style="max-width: 700px;">
														<div class="d-flex align-items-center" style="gap: 5px">
															<i class="fa fa-user" style="font-size: 10px;"></i>
															<span style="font-size: 11px;">{{ anomaly.user_id_id|username }}</span>
														</div>
														<span style="font-size: 0.9rem;"> {{ anomaly.comment }} </span>
													</div>
													<span class="d-flex justify-content-center text-muted" style="font-size: 0.75rem;">
														{{ anomaly.creation_date|add_hours_plus_three|date:"d, M Y G:i" }}
													</span>
												</div>
											{% endif %}
										{% endwith %}
									{% else %}
										{% with anomaly.comment|strip as comment %}
											{% if comment != "" %}
												<div class="d-flex justify-content-end align-items-center" style="gap: 1rem; margin-bottom: 0.4rem;">
													<span class="d-flex justify-content-center text-muted" style="font-size: 0.75rem;">
														{{ anomaly.creation_date|add_hours_plus_three|date:"d, M Y G:i" }}
													</span>
													<div class="container-response" style="max-width: 700px;">
														<div class="d-flex align-items-center" style="gap: 5px">
															<i class="fa fa-users" style="font-size: 10px;"></i>
															<span style="font-size: 11px;">{{ anomaly.user_id_id|username }}</span>
														</div>
														<span style="font-size: 0.9rem;"> {{ anomaly.comment }} </span>
													</div>
												</div>
											{% endif %}
										{% endwith %}
									{% endif %}
								{% endfor %}
							</div>
						{% endif %}
					{% endwith %}
				</div>
			</div>			
		</div>
	</div>
</div>

<!--modal ssr && all other informations-->
<div class="modal fade" id="modal-information" style="display: none;" aria-hidden="true">
	<div class="modal-dialog modal-xl modal-dialog-scrollable">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title">Autres informations</h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">×</span>
				</button>
			</div>
			<div class="modal-body s">
				<div class="row">
					<div class="col-md-12 px-2">
						<h6 class="text-primary">Special Services Request (SSR)</h6>
						<div class="table-responsive">
							<table
								class="table table-bordered table-head-fixed text-nowrap">
								<thead class="bg-info">
									<tr>
										<th width="5%">Ligne</gnth>
										<th width="15%">Code</th>
										<th width="20%">Description</th>
										<th width="20%">Textes sur PNR</th>
										<th>Passager(s)/Segment(s)</th>
										{%  if pnr.status_value == 1 %}
										<th width="15%">OPC</th>
										{% endif %}
									</tr>
								</thead>
								<tbody>
									{% for ssr in pnr|ssrs %}
									<tr>
										<td>{{ ssr.order_line }}</td>
										<td>{{ ssr.ssr.code }}</td>
										<td>{{ ssr|ssr_description }}</td>
										<td>{{ ssr.ssr_text }}</td>
										<td>{{ ssr|ssr_passenger_segment }}</td>
										{%  if pnr.status_value == 1 %}
										<td>{{ ssr|ssr_opc|date:"d/m/y H:i" }}</td>
										{% endif %}
									</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
					</div>
				</div>
				{% if pnr|pnr_history != False %}
				<div class="row">
					<div class="col-md-12 px-2">
						<h6 class="text-primary">Historique de modifications</h6>
						<div class="table-responsive">
							<table
									class="table table-bordered table-head-fixed text-nowrap">
								<thead class="bg-info">
									<tr>
										<th width="5%">Objet modifié</th>
										<th width="5%">Agent modificateur</th>
										<th width="5%">Date de la modification</th>
										<th width="20%">Eléments modifiés</th>
									</tr>
								</thead>
								<tbody>
									{% for history in pnr|pnr_history %}
									<tr>
										{% for key,value in history.items %}
											{% autoescape off %}
											{% if key == 'modification_date' %}
												<td> {{ value | date:"d/m/y H:i" }} </td>
											{% else %}
												<td> {{ value | safe }} </td>
											{% endif %}
											{% endautoescape %}
										{% endfor %}
									</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
					</div>
				</div>
				{% endif %}
				{% if pnr|auxiliary_segment != False %}
				<div class="row">
					<div class="col-md-12 px-2">
						<h6 class="text-primary">Auxiliary segment (SVC)</h6>
						<div class="table-responsive">
							<table
								class="table table-bordered table-head-fixed text-nowrap">
								<thead class="bg-info">
									<tr>
										<th width="5%">Segment</th>
										<th width="5%">Type</th>
										<th width="5%">Compagnie</th>
										<th width="20%">Description</th>
									</tr>
								</thead>
								<tbody>
									{% for svc in pnr|auxiliary_segment %}
									<tr>
										<td>{{ svc.segmentorder }}</td>
										<td>{{ svc.segment_type }}</td>
										<td>{{ svc.servicecarrier }}</td>
										<td>{{ svc.other_segment_description }}</td>
									</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
					</div>
				</div>
				{% endif %}
				{% if pnr|pnr_remarks != False %}
				<div class="row">
					<div class="col-md-12 px-2">
						<h6 class="text-primary">Remarques</h6>
						<div class="table-responsive">
							<table
								class="table table-bordered table-head-fixed text-nowrap tablesorter ticket">
								<thead class="bg-info">
									<tr>
										<th width="5%">Code</th>
										<th width="10%">Description</th>
										<th>Remarque</th>
									</tr>
								</thead>
								<tbody>
									{% for remark in pnr|pnr_remarks %}
									<tr>
										<td>{{ remark.remark.code }}</td>
										<td>{{ remark.remark.type }}</td>
										<td>{{ remark.remark_text }}</td>
									</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
					</div>
				</div>
				{% endif %}
				{% if pnr.children_pnr is not None or pnr.parent_pnr is not None %}
				<div class="row">
					<div class="col-md-12 px-2">
						<h6 class="text-primary">Split et Duplicate</h6>
						<!-- PNR SPLIT -->
						{% if pnr.children_pnr is not None %}
						<div class="table-responsive">
							<table
								class="table table-bordered table-head-fixed text-nowrap tablesorter ticket">
								<thead class="bg-info">
									<tr>
										<th>PNR associés (SPLIT)</th>
									</tr>
								</thead>
								<tbody>
									{% for child in pnr.children_pnr %}
									<tr>
										<td>{{ child }}</td>
									</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
						{% endif %}
						{% if pnr.parent_pnr is not None %}<div class="mb-2">
							{% for passenger in passengers %}
								<div class="pnr-details__passagers">
									{% with passenger.passenger.id|ticket_passenger_status as ticket_passenger_status %}
										{% with passenger.passenger.id|passenger_existence as passenger_existence %}	
											{% with passenger.passenger.id|passenger_is_invoiced as passenger_is_invoiced %}	
												<p class="passagers {% if passenger_is_invoiced %} text-success {% elif ticket_passenger_status %} text-danger {% endif %} " >
													({{ passenger.passenger.order }}) {{ passenger.passenger.name }} 
													{% if passenger.passenger.surname is not None %}
													<span class="text-capitalize">{{ passenger.passenger.surname|title }}</span>
													{% endif %} 
													
													{% if passenger.passenger.designation is not None %}
													<span class="text-capitalize">{{ passenger.passenger.designation|title }}</span>
													{% endif %}
													<input type="hidden" name="passengers-ids" value="{{passenger.passenger.id}}"/>
												</p>
											{% endwith %}
										{% endwith %}
										
									{% endwith %}
								</div>
							{% endfor %}
						</div>
						<!-- PNR DUPLICATE -->
						<div class="table-responsive">
							<table
								class="table table-bordered table-head-fixed text-nowrap tablesorter ticket">
								<thead class="bg-info">
									<tr>
										<th>PNR associés (DUPLICATE)</th>
									</tr>
								</thead>
								<tbody>
									{% for parent in pnr.parent_pnr %}
									<tr>
										<td>{{ parent }}</td>
									</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
						{% endif %}
					</div>
				</div>
				{% endif %}
				{% for raw_line in raw_data %}
				<div class="row">
					<div class="col-md-12 px-2">
						<h6 class="text-primary">Données brutes du: {{ raw_line.data_datetime|add_hours_plus_three|date:"d/m/y H:i" }}</h6>
						<p>{{ raw_line.data_text|linebreaks  }}</p>
					</div>
				</div>
				{% endfor %}
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-danger" data-dismiss="modal">Fermer</button>
			</div>
		</div>
	</div>
</div>
<!--modal add customer-->
<div class="modal fade" id="add-customer" style="display: none; z-index: 1080; overflow-y: auto;" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title">Ajouter un client</h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">×</span>
				</button>
			</div>
			<div class="modal-body">
				<form method="POST" action="" id="customerSaveForm">
					{% csrf_token %}
					<div class="mb-2">
						<label class="form-label">Type <span class="text-primary">(**)</span></label>
						<div class="form-group mb-0">
							<select class="form-control form-control select-type" id="customer-type-int-input" required>
								<option value="Particulier">Particulier</option>
								<option value="Société">Société</option>
							</select>
						</div>
					</div>
					<div class="mb-2 company" hidden>
						<label class="form-label">Société <span class="text-primary">(**)</span></label>
						<input type="text" name="first_name" class="form form-control" id="customer-company-int-input" required/>
					</div>

					<div class="row">
						<div class="col-6">
							<div class="mb-2 customer-name">
								<label class="form-label">Nom <span class="text-primary">(**)</span></label>
								<input type="text" name="first_name" class="form form-control" id="customer-name-int-input" required/>
							</div>
						</div>

						<div class="col-6">
							<div class="mb-2 customer-lastname">
								<label class="form-label">Prénom(s) <span class="text-primary">(**)</span></label>
								<input type="text" name="last_name" class="form form-control" id="customer-firstname-int-input" required/>
							</div>
						</div>
					</div>

					<div class="row">
						<div class="col-6">
							<div class="mb-2 customer-mail">
								<label class="form-label">E-mail <span class="text-primary">(**)</span></label>
								<input type="text" name="mail" class="form form-control" id="customer-mail-input" required/>
							</div>
						</div>
						<div class="col-6">
							<div class="mb-2 customer-phone">
								<label class="form-label">Téléphone <span class="text-primary">(**)</span></label>
								<input type="text" name="phone" class="form form-control" id="customer-phone-input" required/>
							</div>
						</div>
					</div>
					
					<div class="row">
						<div class="col-6">
							<div class="mb-2">
								<label class="form-label">Adresse <span class="text-primary">(**)</span></label>
								<input type="text" name="adresse" class="form form-control" id="customer-address-int-input" required/>
							</div>
						</div>
						<div class="col-6">
							<div class="mb-2">
								<label class="form-label">Adresse secondaire </label>
								<input type="text" name="adresse-2" class="form form-control" id="customer-address-2-int-input" />
							</div>
						</div>
					</div>

					<div class="row">
						<div class="col-6">
							<div class="mb-2">
								<label class="form-label">Code postal</label>
								<input type="text" name="code_postal" class="form form-control" id="customer-code-postal-input" maxlength="5" placeholder="ex: 97600"/>
								<select name="code_postal" class="form form-control" id="customer-code-postal-input"></select>
							</div>
						</div>
						<div class="col-6">
							<div class="mb-2">
								<label class="form-label">Ville</label>
								<input type="text" name="city" class="form form-control" id="customer-city-int-input"/>
								<select name="city" class="form form-control" id="customer-city-int-input"></select>
							</div>
						</div>
					</div>	

					<div class="mb-2">
						<label class="form-label">Département</label>
						<input type="text" name="departement" class="form form-control" id="customer-departement-input"/>
						<select name="departement" class="form form-control" id="customer-departement-input"></select>
					</div>

					<div class="mb-2">
						<label class="form-label">Pays</label>
						<select name="country" class="form form-control" id="customer-country-int-input"></select>
					</div>			

					<div class="mb-0">
						<p class="text-primary mb-0">(**) : Champs obligatoires</p>
					</div>
			</div>
			<div class="modal-footer">
				<button type="submit" class="btn btn-success" id="save-customer-button">
					<i class="fas fa-save"></i> Créer
				</button>
				<button type="button" class="btn btn-danger" data-dismiss="modal">Fermer</button>
			</form>
			</div>
		</div>
	</div>
</div>
<!--modal show customer-->
<div class="modal fade" id="show-customer" style="display: none;" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title">Details du client</h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">×</span>
				</button>
			</div>
			<div class="modal-body">
				<div class="mb-2">
					<label class="form-label mb-0">Intitulé</label>
					<p id="modalBodyCustomerIntitule"></p>
				</div>

				<div class="mb-2">
					<label class="form-label mb-0">E-mail</label>
					<p id="modalBodyCustomerEmail"></p>
				</div>

				<div class="mb-2">
					<label class="form-label mb-0">Téléphone</label>
					<p id="modalBodyCustomerTelephone"></p>
				</div>

				<div class="row">
					<div class="col-6">
						<div class="mb-2">
							<label class="form-label mb-0">Adresse</label>
							<p id="modalBodyCustomerAddressPrimary"></p>
						</div>
					</div>
					<div class="col-6">
						<div class="mb-2">
							<label class="form-label mb-0">Adresse secondaire </label>
							<p id="modalBodyCustomerAddressSecondary"></p>
						</div>
					</div>
				</div>

				<div class="row">
					<div class="col-6">
						<div class="mb-2">
							<label class="form-label mb-0">Code postal</label>
							<p id="modalBodyCustomerPostalCode"></p>
						</div>
					</div>
					<div class="col-6">
						<div class="mb-2">
							<label class="form-label mb-0">Ville</label>
							<p id="modalBodyCustomerCity"></p>
						</div>
					</div>
				</div>
				
				<div class="mb-2">
					<label class="form-label mb-0">Département</label>
					<p id="modalBodyCustomerDepartement"></p>
				</div>
				<div class="mb-2">
					<label class="form-label mb-0">Pays</label>
					<p id="modalBodyCustomerCountry"></p>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary edit-customer">Modifier</button>
				<button type="button" class="btn btn-danger" data-dismiss="modal">Fermer</button>
			</div>
		</div>

	</div>
</div>

<!-- Modal change selected client -->
<div class="modal fade" id="modifySelectedClient" style="display: none;" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title">Changer le client</h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">×</span>
				</button>
			</div>
			<div class="modal-body">
				<div class="mb-2">
					<label class="form-label mb-0">Intitulé</label>
					<p id="modalBodyCustomerIntitule"></p>
					<select class="form-control form-control-sm sm-height customer-modification-selection" style="font-size: 12px;" id="customerModificationSelectionList" data-live-search="true" data-placeholder="Sélectionner le client" >																								
						{% comment %} {% for client in clients %}
							<option value="{{ client.id }}">{{ client }} </option>
						{% endfor %} {% endcomment %}
					</select>
					{% with pnr|passenger_informations as passenger_informations %}
						<a 
							id=""
							class="a-link mb-0 change-customer" 
							role="button" 
							data-toggle="modal"
							data-target="#add-customer" 
							data-passenger-informations="{{ passenger_informations }}"
							style="margin-top:30px;"
							
						>
							<i class="fa fa-pen"></i>Créer un client
						</a>
					{% endwith %}
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary modify-selected-client" id="buttonModifySelectedClient" data-pnr-id="{{ pnr.id }}">Enregistrer</button>
				<button type="button" class="btn btn-danger" data-dismiss="modal">Fermer</button>
			</div>
		</div>

	</div>
</div>
<!-- End of changing selected client -->

<!--modal edit customer-->
<div class="modal fade" id="edit-customers" style="display: none;" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title">Modification du client</h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">×</span>
				</button>
			</div>
			<div class="modal-body">
				<input type="hidden" value="" class="selected-customer-id"/>
				<div class="mb-2">
					<label class="form-label mb-0">Intitulé</label>
					<p id="editModalCustomerIntitule"></p>
				</div>

				<div class="mb-2">
					<label class="form-label mb-0">E-mail</label>
					<input 
						id="editModalCustomerEmail"
						type="text" 
						class="form-control"
						value="" 
						name="input-modify-customer-email"
					>
				</div>
				<div class="mb-2">
					<label class="form-label mb-0">Téléphone</label>
					<input 
						id="editModalCustomerTelephone"
						type="text" 
						class="form-control"
						value="" 
						name="input-modify-customer-telephone"
					>
				</div>

				<div class="row">
					<div class="col-6">
						<div class="mb-2">
							<label class="form-label mb-0">Adresse</label>
							<input 
								id="editModalCustomerAddressPrimary"
								type="text" 
								class="form-control"
								value=""
								name="input-modify-customer-address1"
							>
						</div>
					</div>
					<div class="col-6">
						<div class="mb-2">
							<label class="form-label mb-0">Adresse secondaire </label>
							<input 
								id="editModalCustomerAddressSecondary"
								type="text" 
								class="form-control"
								value=""
								name="input-modify-customer-address2"
							>
						</div>
					</div>
				</div>

				<div class="row">
					<div class="col-6">
						<div class="mb-2">
							<label class="form-label mb-0">Code postale</label>
							<input 
								id="editModalCustomerPostalCode"
								type="text" 
								class="form-control"
								value=""
								name="input-modify-customer-code-postal"
							>
						</div>
					</div>
					<div class="col-6">
						<div class="mb-2">
							<label class="form-label mb-0">Ville</label>
							<input 
								id="editModalCustomerCity"
								type="text" 
								class="form-control"
								value=""
								name="input-modify-customer-city"
							>
						</div>
					</div>
				</div>

				<div class="mb-2">
					<label class="form-label mb-0">Département</label>
					<input 
						id="editModalCustomerDepartement"
						type="text" 
						class="form-control"
						value=""
						name="input-modify-customer-department"
					>
				</div>

				<div class="mb-2">
					<label class="form-label mb-0">Pays</label>
					<input 
						id="editModalCustomerCountry"
						type="text" 
						class="form-control"
						value=""
						name="input-modify-customer-country">
				</div>	
				
				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-success" id="customer-modification-validate">Valider</button>
				<button type="button" class="btn btn-danger" data-dismiss="modal">Fermer</button>
			</div>
		</div>
	</div>
</div>

<!--modal dmdfrs-->
<div class="modal fade" id="modal-dmdfrs" style="display: none;" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title">Demande de diminution de frais de services</h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">×</span>
				</button>
			</div>
			<div class="modal-body">
				<label>Montant :</label>
				<div class="input-group mb-2">
					<input type="text" class="form-control fee-request" id="fee-amount-request">
					<input type="hidden" class="form-control" id="fee-origin-cost" name="fee-origin-cost">
					<input type="hidden" class="form-control" id="fee-id-request" name="fee-id-request">
					<input type='hidden' class="form-control" id="user_id"></input>
					<div class="input-group-append">
						<div class="input-group-text">
							<span class="fas fa-euro"></span>
						</div>
					</div>
				</div>
				<div class="form-group mb-2">
					<label for="feeReduceMotif">Motif :</label>
					<textarea 
						class="form-control fee-reduce-motif" 
						id="feeReduceMotif" 
						placeholder="Quel est le motif ?"
					required></textarea>
				</div>
				<div class="input-group mb-2">
					<label for="only-current-ticket">Appliquer sur ce billet seulement</label>
					<input type="radio" class="form-control" id="only-current-ticket" name="fee-decrease-application" value="one" checked>
					<label for="all-ticket">Appliquer sur tous les billets</label>
					<input type="radio" class="form-control" id="all-ticket" name="fee-decrease-application" value="all">
				</div>
				<div class="alert align-items-center justify-content-center" role="alert" id="feeRequestAlert">
					A simple warning alert—check it out!
				</div>
			</div>
			<div class="modal-footer">
				<button type="submit" id="submitFeeRequest" class="btn btn-success">Envoyer</button>
				<button type="button" class="btn btn-danger" data-dismiss="modal">Annuler</button>
			</div>
		</div>
	</div>
</div>

<!--- Modal create a new client --->
<div class="modal fade" id="createNewClientForOtherPassenger" style="display: none; z-index: 1080" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Voulez-vous utiliser ce client ? </h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">×</span>
				</button>
			</div>
			<div class="modal-body">
				<div class="mb-2">
					<label class="form-label mb-0">Intitulé</label>
					<p id="clientIntituteInformation"></p>
				</div>

				<div class="mb-2">
					<label class="form-label mb-0">E-mail</label>
					<p id="clientEmailInformation"></p>
				</div>
				<div class="mb-2">
					<label class="form-label mb-0">Téléphone</label>
					<p id="clientPhoneInformation"></p>
				</div>

				<div class="mb-2">
					<label class="form-label mb-0">Adresse</label>
					<p id="clientAddressInformation"></p>
				</div>

				<div class="row">
					<div class="col-6">
						<div class="mb-2">
							<label class="form-label mb-0">Code postale</label>
							<p id="clientPostalCodeInformation"></p>
						</div>
					</div>
					<div class="col-6">
						<div class="mb-2">
							<label class="form-label mb-0">Ville</label>
							<p id="clientCityInformation"></p>
						</div>
					</div>
				</div>

				<div class="mb-2">
					<label class="form-label mb-0">Département</label>
					<p id="clientDepartementInformation"></p>
				</div>

				<div class="mb-2">
					<label class="form-label mb-0">Pays</label>
					<p id="clientCountryInformation"></p>
				</div>	
			</div>
			<div class="modal-footer">
				<button type="submit" id="confirmSelectionCustomer" class="btn btn-success" data-dismiss="modal">Confirmer</button>
				<button type="button" id="addNewClientForOtherPassenger" class="btn btn-info" data-toggle="modal" data-target="#add-customer">Créer un nouveau client</button>
			</div>
		</div>
	</div>
</div>
<!-- End of creating a new client modal -->

<div class="modal fade" id="ModalRemoveCustomer" tabindex="-1" role="dialog" aria-labelledby="ModalRemoveCustomer" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
		<div class="modal-header">
		<h5 class="modal-title" id="ModalRemoveCustomer">Voulez-vous vraiment supprimer le client ?</h5>
		<button type="button" class="close" data-dismiss="modal" aria-label="Close">
		<span aria-hidden="true">&times;</span>
		</button>
		</div>
		<div class="modal-body">
		<span id="ModalRemoveCustomerBody"> </span>
		</div>
		<div class="modal-footer">
		<button type="button" class="btn btn-success" id="exitRemoveCustomer"><i class="fa-solid fa-trash"></i> Confirmer</button>
		<button type="button" class="btn btn-danger" data-dismiss="modal"><i></i>Annuler</button>
		</div>
		</div>
	</div>
</div>

<div class="modal fade show" id="modalRemoveOtherFeeService" style="display: none;" aria-modal="true" role="dialog">
	<div class="modal-dialog modal-md">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title">Suppression du service</h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">×</span>
				</button>
			</div>
			<div class="modal-body">
				<span>
					Voulez-vous vraiment supprimer le service 
					<span id="otherFeeDesignation"></span> ?
				</span>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Annuler</button>
				<button type="button" class="btn btn-danger" id="deleteOtherFeeServiceModalConfirmation" data-dismiss="modal">
					<span id="textConfirmationDeleteOtherFeeService"></span>
				</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="ErrorSavingModal" tabindex="-1" role="dialog" aria-labelledby="ErrorSavingModal" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
		<div class="modal-header">
		<h5 class="modal-title" id="ErrorSavingModal">Une erreur s'est produite</h5>
		<button type="button" class="close" data-dismiss="modal" aria-label="Close">
		<span aria-hidden="true">&times;</span>
		</button>
		</div>
		<div class="modal-body">
		<span id="ErrorSavingModalBody">Une erreur s'est produite lors de l'enregistrement veuillez actualiser et réessayez. </span>
		</div>
		<div class="modal-footer">
		<button type="button" class="btn btn-primary" id="RefreshErrorSaving"><i class="fa-solid fa-arrows-rotate"></i> Actualiser</button>
		</div>
		</div>
	</div>
</div>
{% comment %} modal unorder pnr {% endcomment %}
<div class="modal fade" id="modalUncommandApi" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
	<div class="modal-content">
		<div class="modal-header">
		<h5 class="modal-title" id="modalUncommandApiTitle">
			<i class="fa-solid fa-xmark"></i>
			Décommander un PNR
		</h5>
		<button type="button" class="close" data-dismiss="modal" aria-label="Close">
			<span aria-hidden="true">&times;</span>
		</button>
		</div>
		{% with pnr|is_one_or_more_passenger_is_invoiced as is_one_or_more_passenger_is_invoiced %}
			<div class="modal-body">
				<div class="form-group">
						{% if is_one_or_more_passenger_is_invoiced %}
							<input type='hidden' name="user_id" class="form-control" id="user_id" value="{{ user.id }}" ></input>
							<label for="message-text" class="col-form-label">Numero PNR:</label>
							<input type='text' name="pnr_number" class="form-control" id="pnr_number" value="{{ pnr.number }}" disabled=true></input>
							<label for="message-text" class="col-form-label">Numero de commande:</label>
							<select class="custom-select" id="selectNumCommande"></select>
							<label for="message-text" class="col-form-label">Motif:</label>
							<input type='text' name="motif" required class="form-control" id="motif" placeholder="Saisir le motif afin de décommander le PNR"></input>
						{% else %}
							<span>Aucune commande n'a été faite pour ce PNR</span>
						{% endif %}
							
					</div>
				</div>
				{% if is_one_or_more_passenger_is_invoiced %}
					<div class="modal-footer">
						<button type="button" class="btn btn-danger" data-dismiss="modal">Annuler</button>
						<button type="button" class="btn btn-success" id="sendRemovePassengerInvoice" >Envoyer</button>
					</div>
				{% endif %}
			</div>
		{% endwith %}
	</div>
</div>

<div class="modal fade show" id="modalRemoveTicket" style="display: none;" aria-modal="true" role="dialog">
	<div class="modal-dialog modal-md">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title">Annuler billet (voidé ou remonté par erreur)</h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">×</span>
				</button>
			</div>
			<div class="modal-body">
				<span>
					Voulez-vous vraiment annuler le billet
					<span id="ticketNumber"></span> ?
				</span>
				<input type="hidden" id="ticketId" />
				<input type="hidden" id="ticketTable" />
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Annuler</button>
				<button type="button" class="btn btn-danger" id="deletTicketModalConfirmation" data-dismiss="modal">Confirmer
				</button>
			</div>
		</div>
	</div>
</div>

{% endblock content %}